<!-- prettier-ignore -->
{% extends 'base.html' %} 
{% load crispy_forms_tags %} 
{% block title %} calculate distance {% endblock title%}
{% block content %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</br>

{{ map|safe }} 

</br>
<div class="infobox" style="display:none;">
{% include 'snippets/infobox.html' %}
</div>
{% if request.user.is_authenticated %}
<form action="" method="POST" autocomplete="off">
  {% csrf_token %} {{form|crispy}}
  <button type="submit" class="btn btn-primary">Confirm</button>
</form>
{% endif %}
<br />
This product includes GeoLite2 data created by MaxMind, available from
<a href="https://www.maxmind.com">https://www.maxmind.com</a>.
<script>
  const scriptTag =
    '<script>' +
    "function sendId() {const text = $('b').attr('id'); window.parent.postMessage(text); $(function(){$('.leaflet-popup-close-button').click(function(){window.parent.postMessage('close');});});};" + 
    '<\/script>';

  cleanInfo = () => {
        $('#castle-name').text('');
        $('#castle-type').text('');
        $('#castle-website').text('');
  };

  $('iframe').contents().find('body').append(scriptTag);
  $(document).ready(function(){
    $("#close-btn").click(function(){
      $(".infobox").hide();
    });
  });
  const iframe = document.getElementsByTagName('iframe')[0];
  let iWindow = null;

  window.addEventListener('message', event => {
    const { data } = event;
    if(data === 'close') {
      $(".infobox").hide();
    } else {
      $.ajax({
        method: 'GET',
        data: { castle_id: data,
                loc_id: data },
        success: function (resp) {
          cleanInfo();
          $('#castle-name').text(resp.name);
          $('#castle-type').text(resp.castle_type);
          $('#castle-website').text(resp.website);

          $('.infobox').show()
        },
      });
    }
  });
</script>
<script src="../static/js/map.js"></script>
{% endblock content %}
